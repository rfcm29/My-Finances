<!DOCTYPE html>
<html lang="pt" xmlns:th="http://www.thymeleaf.org" xmlns:layout="http://www.ultraq.net.nz/thymeleaf/layout" layout:decorate="~{layout/main}">

<head>
    <title>Adicionar Investimento - MyFinances</title>
</head>

<body>
    <div layout:fragment="content">
        <div class="container-fluid">
            <div class="row">
                <div class="col-12">
                    <div class="d-flex justify-content-between align-items-center mb-4">
                        <h1 class="h3 text-gray-800">
                            <i class="fas fa-plus me-2"></i>Adicionar Investimento
                        </h1>
                        <div>
                            <a th:href="@{/investments}" class="btn btn-secondary">
                                <i class="fas fa-arrow-left me-1"></i> Voltar ao Portfolio
                            </a>
                            <a th:href="@{/investments/products/search-api}" class="btn btn-info">
                                <i class="fas fa-search me-1"></i> Pesquisar Produtos
                            </a>
                        </div>
                    </div>

                    <div class="row">
                        <div class="col-lg-8">
                            <div class="card shadow">
                                <div class="card-header py-3">
                                    <h6 class="m-0 font-weight-bold text-primary">Detalhes do Investimento</h6>
                                </div>
                                <div class="card-body">
                                    <form th:action="@{/investments/add}" method="post" th:object="${investmentForm}">
                                        
                                        <!-- Product Selection -->
                                        <div class="form-group mb-3">
                                            <label for="productId">Produto de Investimento *</label>
                                            <select class="form-control" id="productId" th:field="*{productId}" required>
                                                <option value="">Selecione um produto...</option>
                                                <option th:each="product : ${products}" 
                                                        th:value="${product.id}" 
                                                        th:text="|${product.symbol} - ${product.name} (${product.currency})|">
                                                    AAPL - Apple Inc. (USD)
                                                </option>
                                            </select>
                                            <small class="form-text text-muted">
                                                Não encontra o produto? <a th:href="@{/investments/products/search-api}">Pesquise via API</a>
                                            </small>
                                            <div th:if="${#fields.hasErrors('productId')}" class="invalid-feedback d-block">
                                                <span th:errors="*{productId}"></span>
                                            </div>
                                        </div>

                                        <div class="row">
                                            <!-- Quantity -->
                                            <div class="col-md-6">
                                                <div class="form-group mb-3">
                                                    <label for="quantity">Quantidade *</label>
                                                    <input type="number" class="form-control" id="quantity" 
                                                           th:field="*{quantity}" step="0.000001" min="0.000001" required>
                                                    <small class="form-text text-muted">
                                                        Número de ações/unidades compradas
                                                    </small>
                                                    <div th:if="${#fields.hasErrors('quantity')}" class="invalid-feedback d-block">
                                                        <span th:errors="*{quantity}"></span>
                                                    </div>
                                                </div>
                                            </div>

                                            <!-- Purchase Price -->
                                            <div class="col-md-6">
                                                <div class="form-group mb-3">
                                                    <label for="purchasePrice">Preço de Compra *</label>
                                                    <input type="number" class="form-control" id="purchasePrice" 
                                                           th:field="*{purchasePrice}" step="0.01" min="0.01" required>
                                                    <small class="form-text text-muted">
                                                        Preço pago por ação/unidade
                                                    </small>
                                                    <div th:if="${#fields.hasErrors('purchasePrice')}" class="invalid-feedback d-block">
                                                        <span th:errors="*{purchasePrice}"></span>
                                                    </div>
                                                </div>
                                            </div>
                                        </div>

                                        <div class="row">
                                            <!-- Purchase Date -->
                                            <div class="col-md-6">
                                                <div class="form-group mb-3">
                                                    <label for="purchaseDate">Data de Compra *</label>
                                                    <input type="date" class="form-control" id="purchaseDate" 
                                                           th:field="*{purchaseDate}" required>
                                                    <div th:if="${#fields.hasErrors('purchaseDate')}" class="invalid-feedback d-block">
                                                        <span th:errors="*{purchaseDate}"></span>
                                                    </div>
                                                </div>
                                            </div>

                                            <!-- Exchange Rate -->
                                            <div class="col-md-6">
                                                <div class="form-group mb-3">
                                                    <label for="exchangeRate">Taxa de Câmbio (para EUR)</label>
                                                    <input type="number" class="form-control" id="exchangeRate" 
                                                           th:field="*{exchangeRate}" step="0.000001" min="0.000001">
                                                    <small class="form-text text-muted">
                                                        Taxa de conversão para EUR (deixe 1.0 se já em EUR)
                                                    </small>
                                                    <div th:if="${#fields.hasErrors('exchangeRate')}" class="invalid-feedback d-block">
                                                        <span th:errors="*{exchangeRate}"></span>
                                                    </div>
                                                </div>
                                            </div>
                                        </div>

                                        <!-- Notes -->
                                        <div class="form-group mb-3">
                                            <label for="notes">Notas (opcional)</label>
                                            <textarea class="form-control" id="notes" th:field="*{notes}" rows="3"
                                                      placeholder="Notas sobre este investimento..."></textarea>
                                            <small class="form-text text-muted">
                                                Informações adicionais sobre o investimento
                                            </small>
                                        </div>

                                        <div class="form-group">
                                            <button type="submit" class="btn btn-primary">
                                                <i class="fas fa-save me-1"></i> Adicionar Investimento
                                            </button>
                                            <a th:href="@{/investments}" class="btn btn-secondary ms-2">Cancelar</a>
                                        </div>

                                    </form>
                                </div>
                            </div>
                        </div>

                        <!-- Sidebar with help -->
                        <div class="col-lg-4">
                            <div class="card shadow">
                                <div class="card-header py-3">
                                    <h6 class="m-0 font-weight-bold text-primary">Ajuda</h6>
                                </div>
                                <div class="card-body">
                                    <h6 class="text-primary">Como adicionar um investimento:</h6>
                                    <ol class="small">
                                        <li><strong>Produto:</strong> Selecione ou procure o produto de investimento desejado</li>
                                        <li><strong>Quantidade:</strong> Insira o número de ações/unidades compradas</li>
                                        <li><strong>Preço:</strong> Valor pago por ação/unidade</li>
                                        <li><strong>Data:</strong> Quando foi realizada a compra</li>
                                        <li><strong>Taxa de Câmbio:</strong> Para converter para EUR (opcional)</li>
                                    </ol>

                                    <div class="alert alert-info" role="alert">
                                        <i class="fas fa-lightbulb me-2"></i>
                                        <strong>Dica:</strong> Se não encontrar o produto desejado, 
                                        use a função "Pesquisar via API" para encontrar e adicionar 
                                        novos produtos automaticamente.
                                    </div>

                                    <div class="alert alert-warning" role="alert">
                                        <i class="fas fa-info-circle me-2"></i>
                                        <strong>Nota:</strong> Os preços atuais dos produtos são 
                                        atualizados automaticamente via Yahoo Finance API.
                                    </div>
                                </div>
                            </div>

                            <!-- Product preview (if productId selected) -->
                            <div class="card shadow mt-4" id="productPreview" style="display: none;">
                                <div class="card-header py-3">
                                    <h6 class="m-0 font-weight-bold text-primary">Preview do Produto</h6>
                                </div>
                                <div class="card-body" id="productDetails">
                                    <!-- Will be filled via JavaScript -->
                                </div>
                            </div>
                        </div>
                    </div>

                </div>
            </div>
        </div>
    </div>

    <!-- Scripts -->
    <div layout:fragment="scripts">
        <script>
            // Calculate total investment value
            function updateCalculations() {
                const quantity = parseFloat(document.getElementById('quantity').value) || 0;
                const price = parseFloat(document.getElementById('purchasePrice').value) || 0;
                const exchangeRate = parseFloat(document.getElementById('exchangeRate').value) || 1;
                
                const totalInvested = quantity * price;
                const totalInvestedEUR = totalInvested / exchangeRate;
                
                // You could show these calculations in the UI if needed
                console.log(`Total invested: ${totalInvested}, EUR: ${totalInvestedEUR}`);
            }

            // Add event listeners for real-time calculation
            document.getElementById('quantity').addEventListener('input', updateCalculations);
            document.getElementById('purchasePrice').addEventListener('input', updateCalculations);
            document.getElementById('exchangeRate').addEventListener('input', updateCalculations);

            // Set today as default date
            document.getElementById('purchaseDate').valueAsDate = new Date();
        </script>
    </div>
</body>
</html>