<!DOCTYPE html>
<html lang="pt" xmlns:th="http://www.thymeleaf.org"
      xmlns:layout="http://www.ultraq.net.nz/thymeleaf/layout"
      layout:decorate="~{layout/main}">
<head>
    <title>Nova Conta</title>
</head>
<body>
    <div layout:fragment="content">
        <div class="d-flex justify-content-between align-items-center mb-4">
            <div>
                <h1 class="h3 fw-bold text-dark mb-1">Nova Conta</h1>
                <p class="text-muted mb-0">
                    <i class="fas fa-plus me-1"></i>Criar uma nova conta financeira
                </p>
            </div>
            <div>
                <a th:href="@{/accounts}" class="btn btn-outline-secondary">
                    <i class="fas fa-arrow-left me-2"></i>Voltar
                </a>
            </div>
        </div>

        <div class="row justify-content-center">
            <div class="col-md-8 col-lg-6">
                <div class="card card-primary">
                    <div class="card-header">
                        <h6 class="card-title mb-0">
                            <i class="fas fa-wallet me-2"></i>Detalhes da Conta
                        </h6>
                    </div>
                    <div class="card-body">
                        <form th:action="@{/accounts/add}" method="post" th:object="${accountForm}">
                            
                            <!-- Account Name -->
                            <div class="mb-3">
                                <label for="name" class="form-label">
                                    <i class="fas fa-tag me-2"></i>Nome da Conta
                                </label>
                                <input type="text" class="form-control form-control-lg" 
                                       th:field="*{name}"
                                       th:class="${#fields.hasErrors('name')} ? 'form-control form-control-lg is-invalid' : 'form-control form-control-lg'"
                                       id="name"
                                       placeholder="Ex: Conta Corrente CGD" required autofocus>
                                <div class="invalid-feedback" th:if="${#fields.hasErrors('name')}" th:errors="*{name}"></div>
                            </div>

                            <!-- Account Category -->
                            <div class="mb-3">
                                <label for="category" class="form-label">
                                    <i class="fas fa-folder me-2"></i>Categoria
                                </label>
                                <select class="form-select" 
                                        th:field="*{category}"
                                        th:class="${#fields.hasErrors('category')} ? 'form-select is-invalid' : 'form-select'"
                                        id="category" 
                                        required>
                                    <option value="">Selecione uma categoria</option>
                                    <option th:each="category : ${categories}" th:value="${category}" th:text="${category}"></option>
                                </select>
                                <div class="invalid-feedback" th:if="${#fields.hasErrors('category')}" th:errors="*{category}"></div>
                            </div>

                            <!-- Account Subcategory -->
                            <div class="mb-3" id="subcategoryDiv" style="display: none;">
                                <label for="subcategory" class="form-label">
                                    <i class="fas fa-tag me-2"></i>Subcategoria
                                </label>
                                <select class="form-select" 
                                        th:field="*{subcategory}"
                                        th:class="${#fields.hasErrors('subcategory')} ? 'form-select is-invalid' : 'form-select'"
                                        id="subcategory">
                                    <option value="">Selecione uma subcategoria</option>
                                </select>
                                <div class="invalid-feedback" th:if="${#fields.hasErrors('subcategory')}" th:errors="*{subcategory}"></div>
                            </div>

                            <!-- Currency -->
                            <div class="mb-3">
                                <label for="currency" class="form-label">
                                    <i class="fas fa-coins me-2"></i>Moeda
                                </label>
                                <select class="form-select" 
                                        th:field="*{currency}"
                                        th:class="${#fields.hasErrors('currency')} ? 'form-select is-invalid' : 'form-select'"
                                        id="currency">"
                                        required>
                                    <option value="EUR">EUR - Euro (€)</option>
                                    <option value="USD">USD - Dólar Americano ($)</option>
                                    <option value="GBP">GBP - Libra Esterlina (£)</option>
                                    <option value="CHF">CHF - Franco Suíço (Fr)</option>
                                    <option value="JPY">JPY - Yen Japonês (¥)</option>
                                </select>
                                <div class="invalid-feedback" th:if="${#fields.hasErrors('currency')}" th:errors="*{currency}"></div>
                            </div>

                            <!-- Initial Balance -->
                            <div class="mb-4">
                                <label for="initialBalance" class="form-label">
                                    <i class="fas fa-euro-sign me-2"></i>Saldo Inicial
                                </label>
                                <div class="input-group">
                                    <input type="number" step="0.01" min="0.00" class="form-control form-control-lg" 
                                           th:field="*{initialBalance}"
                                           th:class="${#fields.hasErrors('initialBalance')} ? 'form-control form-control-lg is-invalid' : 'form-control form-control-lg'"
                                           id="initialBalance"
                                           placeholder="0,00">
                                    <span class="input-group-text">€</span>
                                    <div class="invalid-feedback" th:if="${#fields.hasErrors('initialBalance')}" th:errors="*{initialBalance}"></div>
                                </div>
                                <div class="form-text">
                                    <small class="text-muted">
                                        <i class="fas fa-info-circle me-1"></i>
                                        O saldo atual da conta. Deixe em 0 se ainda não tem dinheiro nesta conta.
                                    </small>
                                </div>
                            </div>

                            <!-- Submit Buttons -->
                            <div class="d-grid gap-2 d-md-flex justify-content-md-end">
                                <a th:href="@{/accounts}" class="btn btn-outline-secondary me-md-2">
                                    <i class="fas fa-times me-2"></i>Cancelar
                                </a>
                                <button type="submit" class="btn btn-primary">
                                    <i class="fas fa-save me-2"></i>Criar Conta
                                </button>
                            </div>
                        </form>
                    </div>
                </div>

                <!-- Category Info Card -->
                <div class="card mt-4">
                    <div class="card-body">
                        <h6 class="card-title">
                            <i class="fas fa-lightbulb text-warning me-2"></i>Categorias de Conta
                        </h6>
                        <div class="row g-3">
                            <div class="col-md-6">
                                <div class="d-flex">
                                    <i class="fas fa-university text-primary me-2 mt-1"></i>
                                    <div>
                                        <strong>Contas Bancárias</strong>
                                        <br><small class="text-muted">Contas bancárias tradicionais (à ordem, poupança, ordenado, jovem)</small>
                                    </div>
                                </div>
                            </div>
                            <div class="col-md-6">
                                <div class="d-flex">
                                    <i class="fas fa-landmark text-success me-2 mt-1"></i>
                                    <div>
                                        <strong>Poupanças do Estado</strong>
                                        <br><small class="text-muted">Certificados de aforro, tesouro e obrigações</small>
                                    </div>
                                </div>
                            </div>
                            <div class="col-md-6">
                                <div class="d-flex">
                                    <i class="fas fa-credit-card text-danger me-2 mt-1"></i>
                                    <div>
                                        <strong>Crédito</strong>
                                        <br><small class="text-muted">Cartões de crédito, empréstimos pessoais, habitação, auto</small>
                                    </div>
                                </div>
                            </div>
                            <div class="col-md-6">
                                <div class="d-flex">
                                    <i class="fas fa-mobile-alt text-info me-2 mt-1"></i>
                                    <div>
                                        <strong>Carteiras Digitais</strong>
                                        <br><small class="text-muted">PayPal, Revolut, MB Way, Wise, outras</small>
                                    </div>
                                </div>
                            </div>
                            <div class="col-md-6">
                                <div class="d-flex">
                                    <i class="fas fa-money-bill-wave text-warning me-2 mt-1"></i>
                                    <div>
                                        <strong>Dinheiro</strong>
                                        <br><small class="text-muted">Dinheiro físico na carteira, cofre ou mealheiro</small>
                                    </div>
                                </div>
                            </div>
                            <div class="col-md-6">
                                <div class="d-flex">
                                    <i class="fas fa-chart-line text-purple me-2 mt-1"></i>
                                    <div>
                                        <strong>Investimentos</strong>
                                        <br><small class="text-muted">Contas de corretagem, bancos de investimento, cripto, fundos</small>
                                    </div>
                                </div>
                            </div>
                        </div>
                    </div>
                </div>

                <!-- Tips Card -->
                <div class="card mt-4">
                    <div class="card-body">
                        <h6 class="card-title">
                            <i class="fas fa-tips text-info me-2"></i>Dicas
                        </h6>
                        <ul class="small text-muted mb-0">
                            <li>Escolha um nome descritivo para identificar facilmente a conta</li>
                            <li>O saldo inicial deve refletir o valor atual na conta</li>
                            <li>Pode criar múltiplas contas do mesmo tipo</li>
                            <li>Contas desativadas não aparecem nas transações</li>
                        </ul>
                    </div>
                </div>
            </div>
        </div>
    </div>

    <script layout:fragment="scripts" th:inline="javascript">
        // Category-Subcategory mapping from server
        const categorySubcategories = /*[[${categorySubcategories}]]*/ {};

        const categorySelect = document.getElementById('category');
        const subcategorySelect = document.getElementById('subcategory');
        const subcategoryDiv = document.getElementById('subcategoryDiv');
        const nameInput = document.querySelector('input[name="name"]');
        
        // Handle category change
        categorySelect.addEventListener('change', function() {
            const selectedCategory = this.value;
            
            // Clear subcategory options
            subcategorySelect.innerHTML = '<option value="">Selecione uma subcategoria</option>';
            
            if (selectedCategory && categorySubcategories[selectedCategory] && categorySubcategories[selectedCategory].length > 0) {
                // Show subcategory dropdown - this category has subcategories
                subcategoryDiv.style.display = 'block';
                subcategorySelect.required = true;
                
                // Populate subcategories
                categorySubcategories[selectedCategory].forEach(subcategory => {
                    const option = document.createElement('option');
                    option.value = subcategory;
                    option.textContent = subcategory;
                    subcategorySelect.appendChild(option);
                });
            } else {
                // Hide subcategory dropdown - this category has no subcategories
                subcategoryDiv.style.display = 'none';
                subcategorySelect.required = false;
                subcategorySelect.value = '';
            }
            
            // Update name placeholder
            updateNamePlaceholder(selectedCategory, '');
        });
        
        // Handle subcategory change
        subcategorySelect.addEventListener('change', function() {
            const category = categorySelect.value;
            const subcategory = this.value;
            updateNamePlaceholder(category, subcategory);
        });
        
        function updateNamePlaceholder(category, subcategory) {
            if (!nameInput || nameInput.value) return;
            
            let suggestion = '';
            if (subcategory) {
                suggestion = subcategory + ' ';
            } else if (category) {
                switch(category) {
                    case 'Carteiras Digitais':
                        suggestion = 'PayPal';
                        break;
                    case 'Dinheiro':
                        suggestion = 'Carteira';
                        break;
                    case 'Investimentos':
                        suggestion = 'Conta Investimento ';
                        break;
                    default:
                        suggestion = category + ' ';
                        break;
                }
            }
            
            nameInput.placeholder = suggestion ? 'Ex: ' + suggestion : 'Ex: Conta à Ordem CGD';
        }
        
        
        // Format balance input
        const balanceInput = document.querySelector('input[name="initialBalance"]');
        if (balanceInput) {
            balanceInput.addEventListener('input', function() {
                let value = this.value.replace(/[^\d.,]/g, '');
                this.value = value;
            });
        }
    </script>

    <style layout:fragment="styles">
        .account-type-btn {
            height: 80px;
            display: flex;
            flex-direction: column;
            justify-content: center;
            padding: 0.5rem;
        }
        
        .account-type-btn i {
            font-size: 1.5rem;
        }
        
        .account-type-btn:hover {
            transform: translateY(-2px);
            transition: transform 0.2s ease-in-out;
        }
    </style>
</body>
</html>