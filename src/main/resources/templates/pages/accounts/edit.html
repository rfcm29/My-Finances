<!DOCTYPE html>
<html lang="pt" xmlns:th="http://www.thymeleaf.org"
      xmlns:layout="http://www.ultraq.net.nz/thymeleaf/layout"
      layout:decorate="~{layout/main}">
<head>
    <title>Editar Conta</title>
</head>
<body>
    <div layout:fragment="content">
        <div class="d-flex justify-content-between align-items-center mb-4">
            <div>
                <h1 class="h3 fw-bold text-dark mb-1">Editar Conta</h1>
                <p class="text-muted mb-0">
                    <i class="fas fa-edit me-1"></i>Atualizar informações da conta
                    <span th:if="${account}" th:text="' - ' + ${account.name}"></span>
                </p>
            </div>
            <div>
                <a th:href="@{/accounts}" class="btn btn-outline-secondary">
                    <i class="fas fa-arrow-left me-2"></i>Voltar
                </a>
            </div>
        </div>

        <div class="row justify-content-center">
            <div class="col-md-8 col-lg-6">
                <div class="card">
                    <div class="card-header">
                        <h6 class="card-title mb-0">
                            <i class="fas fa-wallet me-2"></i>Detalhes da Conta
                        </h6>
                    </div>
                    <div class="card-body">
                        <form th:action="@{/accounts/edit/{id}(id=${account.id})}" method="post" th:object="${accountForm}">
                            
                            <!-- Account Name -->
                            <div class="mb-3">
                                <label for="name" class="form-label">
                                    <i class="fas fa-tag me-2"></i>Nome da Conta
                                </label>
                                <input type="text" class="form-control form-control-lg" 
                                       th:field="*{name}"
                                       th:class="${#fields.hasErrors('name')} ? 'form-control form-control-lg is-invalid' : 'form-control form-control-lg'"
                                       placeholder="Ex: Conta Corrente CGD" required autofocus>
                                <div class="invalid-feedback" th:if="${#fields.hasErrors('name')}" th:errors="*{name}"></div>
                            </div>

                            <!-- Account Category -->
                            <div class="mb-3">
                                <label for="category" class="form-label">
                                    <i class="fas fa-folder me-2"></i>Categoria
                                </label>
                                <select class="form-select" 
                                        th:field="*{category}"
                                        th:class="${#fields.hasErrors('category')} ? 'form-select is-invalid' : 'form-select'"
                                        id="category" 
                                        required>
                                    <option value="">Selecione uma categoria</option>
                                    <option th:each="category : ${categories}" th:value="${category}" th:text="${category}"></option>
                                </select>
                                <div class="invalid-feedback" th:if="${#fields.hasErrors('category')}" th:errors="*{category}"></div>
                            </div>

                            <!-- Account Subcategory -->
                            <div class="mb-3" id="subcategoryDiv" style="display: none;">
                                <label for="subcategory" class="form-label">
                                    <i class="fas fa-tag me-2"></i>Subcategoria
                                </label>
                                <select class="form-select" 
                                        th:field="*{subcategory}"
                                        th:class="${#fields.hasErrors('subcategory')} ? 'form-select is-invalid' : 'form-select'"
                                        id="subcategory">
                                    <option value="">Selecione uma subcategoria</option>
                                </select>
                                <div class="invalid-feedback" th:if="${#fields.hasErrors('subcategory')}" th:errors="*{subcategory}"></div>
                            </div>

                            <!-- Currency -->
                            <div class="mb-3">
                                <label for="currency" class="form-label">
                                    <i class="fas fa-coins me-2"></i>Moeda
                                </label>
                                <select class="form-select" 
                                        th:field="*{currency}"
                                        th:class="${#fields.hasErrors('currency')} ? 'form-select is-invalid' : 'form-select'"
                                        required>
                                    <option value="EUR">EUR - Euro (€)</option>
                                    <option value="USD">USD - Dólar Americano ($)</option>
                                    <option value="GBP">GBP - Libra Esterlina (£)</option>
                                    <option value="CHF">CHF - Franco Suíço (Fr)</option>
                                    <option value="JPY">JPY - Yen Japonês (¥)</option>
                                </select>
                                <div class="invalid-feedback" th:if="${#fields.hasErrors('currency')}" th:errors="*{currency}"></div>
                            </div>

                            <!-- Current Balance -->
                            <div class="mb-4">
                                <label for="initialBalance" class="form-label">
                                    <i class="fas fa-euro-sign me-2"></i>Saldo Atual
                                </label>
                                <div class="input-group">
                                    <input type="number" step="0.01" class="form-control form-control-lg" 
                                           th:field="*{initialBalance}"
                                           th:class="${#fields.hasErrors('initialBalance')} ? 'form-control form-control-lg is-invalid' : 'form-control form-control-lg'"
                                           placeholder="0,00">
                                    <span class="input-group-text">€</span>
                                    <div class="invalid-feedback" th:if="${#fields.hasErrors('initialBalance')}" th:errors="*{initialBalance}"></div>
                                </div>
                                <div class="form-text">
                                    <small class="text-muted">
                                        <i class="fas fa-info-circle me-1"></i>
                                        Alterar este valor criará uma transação de ajuste para refletir a diferença.
                                    </small>
                                </div>
                            </div>

                            <!-- Submit Buttons -->
                            <div class="d-grid gap-2 d-md-flex justify-content-md-end">
                                <a th:href="@{/accounts}" class="btn btn-outline-secondary me-md-2">
                                    <i class="fas fa-times me-2"></i>Cancelar
                                </a>
                                <button type="submit" class="btn btn-primary">
                                    <i class="fas fa-save me-2"></i>Atualizar Conta
                                </button>
                            </div>
                        </form>
                    </div>
                </div>

                <!-- Account History Card -->
                <div class="card mt-4" th:if="${account}">
                    <div class="card-header">
                        <h6 class="card-title mb-0">
                            <i class="fas fa-history me-2"></i>Informações da Conta
                        </h6>
                    </div>
                    <div class="card-body">
                        <div class="row g-3">
                            <div class="col-md-6">
                                <div class="d-flex justify-content-between">
                                    <small class="text-muted">Criada em:</small>
                                    <small class="fw-medium" th:text="${#temporals.format(account.createdAt, 'dd/MM/yyyy')}">01/01/2024</small>
                                </div>
                            </div>
                            <div class="col-md-6">
                                <div class="d-flex justify-content-between">
                                    <small class="text-muted">Status:</small>
                                    <span th:if="${account.active}" class="badge bg-success">Ativa</span>
                                    <span th:unless="${account.active}" class="badge bg-secondary">Inativa</span>
                                </div>
                            </div>
                        </div>
                    </div>
                </div>

                <!-- Tips Card -->
                <div class="card mt-4">
                    <div class="card-body">
                        <h6 class="card-title">
                            <i class="fas fa-lightbulb text-warning me-2"></i>Dicas
                        </h6>
                        <ul class="small text-muted mb-0">
                            <li>Alterações no saldo criarão uma transação de ajuste automática</li>
                            <li>O tipo de conta afeta como ela aparece nos relatórios</li>
                            <li>Contas inativas não podem receber novas transações</li>
                            <li>Pode ativar/desativar a conta na página de listagem</li>
                        </ul>
                    </div>
                </div>
            </div>
        </div>
    </div>

    <script layout:fragment="scripts">
        // Category-Subcategory mapping from server
        const categorySubcategories = /*[[${categorySubcategories}]]*/ {};
        
        const categorySelect = document.getElementById('category');
        const subcategorySelect = document.getElementById('subcategory');
        const subcategoryDiv = document.getElementById('subcategoryDiv');
        
        // Initialize subcategory dropdown on page load
        function initializeSubcategories() {
            const selectedCategory = categorySelect.value;
            
            // Clear subcategory options
            subcategorySelect.innerHTML = '<option value="">Selecione uma subcategoria</option>';
            
            if (selectedCategory && categorySubcategories[selectedCategory] && categorySubcategories[selectedCategory].length > 0) {
                // Show subcategory dropdown - this category has subcategories
                subcategoryDiv.style.display = 'block';
                subcategorySelect.required = true;
                
                // Populate subcategories
                categorySubcategories[selectedCategory].forEach(subcategory => {
                    const option = document.createElement('option');
                    option.value = subcategory;
                    option.textContent = subcategory;
                    // Select current subcategory if it matches
                    const currentSubcategory = /*[[${accountForm.subcategory}]]*/ '';
                    if (subcategory === currentSubcategory) {
                        option.selected = true;
                    }
                    subcategorySelect.appendChild(option);
                });
            } else {
                // Hide subcategory dropdown - this category has no subcategories
                subcategoryDiv.style.display = 'none';
                subcategorySelect.required = false;
                subcategorySelect.value = '';
            }
        }
        
        // Handle category change
        categorySelect.addEventListener('change', function() {
            const selectedCategory = this.value;
            
            // Clear subcategory options
            subcategorySelect.innerHTML = '<option value="">Selecione uma subcategoria</option>';
            
            if (selectedCategory && categorySubcategories[selectedCategory] && categorySubcategories[selectedCategory].length > 0) {
                // Show subcategory dropdown - this category has subcategories
                subcategoryDiv.style.display = 'block';
                subcategorySelect.required = true;
                
                // Populate subcategories
                categorySubcategories[selectedCategory].forEach(subcategory => {
                    const option = document.createElement('option');
                    option.value = subcategory;
                    option.textContent = subcategory;
                    subcategorySelect.appendChild(option);
                });
            } else {
                // Hide subcategory dropdown - this category has no subcategories
                subcategoryDiv.style.display = 'none';
                subcategorySelect.required = false;
                subcategorySelect.value = '';
            }
        });
        
        // Initialize on page load
        document.addEventListener('DOMContentLoaded', function() {
            initializeSubcategories();
        });
        
        // Format balance input
        const balanceInput = document.querySelector('input[name="initialBalance"]');
        if (balanceInput) {
            balanceInput.addEventListener('input', function() {
                let value = this.value.replace(/[^\d.,]/g, '');
                this.value = value;
            });
        }
    </script>

    <style layout:fragment="styles">
        .account-type-btn {
            height: 80px;
            display: flex;
            flex-direction: column;
            justify-content: center;
            padding: 0.5rem;
        }
        
        .account-type-btn i {
            font-size: 1.5rem;
        }
        
        .account-type-btn:hover {
            transform: translateY(-2px);
            transition: transform 0.2s ease-in-out;
        }
    </style>
</body>
</html>